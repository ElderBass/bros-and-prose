<template>
    <AppLayout>
        <PageTitle title="take a closer look" />
        <div v-if="isLoading" class="spinner-container">
            <LoadingSpinner
                v-if="isLoading"
                size="large"
                message="retrieving the book..."
            />
        </div>
        <PastBookDetail
            v-else
            :book="book"
            :userReviews="userReviews"
            :aggregateRating="aggregateRating"
        />
        <AddCommentFab @click="openAddCommentModal" />
        <AddCommentModal
            v-if="showAddCommentModal"
            :open="showAddCommentModal"
            @submit="handleSubmitComment"
            @close="showAddCommentModal = false"
        />
    </AppLayout>
</template>

<script setup lang="ts">
import { onMounted, ref, watch } from "vue";
import AppLayout from "../layout/AppLayout.vue";
import type { Book, BroReview, Comment } from "@/types";
import { useRoute } from "vue-router";
import { useBooks } from "@/composables/useBooks";
import { DISCUSSION_COMMENT_ADDED_SUCCESS_ALERT } from "@/constants";
import { useUIStore } from "@/stores/ui";
import PastBookDetail from "@/components/features/PastBooks/PastBookDetail.vue";
import AddCommentFab from "@/components/features/PastBooks/AddCommentFab.vue";
import AddCommentModal from "@/components/modal/AddCommentModal.vue";
import { getReviewsAndAverageRating } from "@/utils";

const { addDiscussionComment, getPastBook } = useBooks();
const { showAlert } = useUIStore();
const route = useRoute();

const book = ref<Book>({} as Book);
const userReviews = ref<BroReview[]>([]);
const aggregateRating = ref("");
const isLoading = ref(true);
const showAddCommentModal = ref(false);

const openAddCommentModal = () => {
    showAddCommentModal.value = true;
};

const loadBookData = async () => {
    isLoading.value = true;
    const bookId = route.params.bookId as string;
    const fetchedBook = await getPastBook(bookId);
    book.value = fetchedBook;
    const { reviews, averageRating } = getReviewsAndAverageRating(fetchedBook);
    userReviews.value = reviews;
    aggregateRating.value = averageRating;
    isLoading.value = false;
};

const handleSubmitComment = async (comment: Comment) => {
    isLoading.value = true;
    await addDiscussionComment(book.value, comment);
    showAddCommentModal.value = false;
    showAlert(DISCUSSION_COMMENT_ADDED_SUCCESS_ALERT);
    await loadBookData();
};

onMounted(async () => {
    await loadBookData();
});

watch(
    () => route.params.bookId,
    async (newBookId, oldBookId) => {
        if (newBookId && newBookId !== oldBookId) {
            await loadBookData();
        }
    }
);
</script>

<style scoped>
.spinner-container {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
}

@media (max-width: 768px) {
    .book-detail-container {
        flex-direction: column;
        gap: 2rem;
    }
}
</style>
