<template>
    <BaseCard shadow-color="lavender" size="medium">
        <div class="future-book-item">
            <FutureBookItemInfo :book="book" />
            <div class="footer">
                <VoteCount :voteCount="book.votes.length - 1 || 0" />
                <VoteActions
                    v-if="!userIsFutureBookSelector"
                    :voteCount="book.votes.length - 1 || 0"
                    :userHasVoted="userHasVoted"
                    :handleVote="handleVote"
                />
                <EditActions
                    v-if="userIsFutureBookSelector"
                    :handleEdit="handleEdit"
                    :handleDelete="handleDelete"
                />
            </div>
        </div>
    </BaseCard>
</template>

<script setup lang="ts">
import { ref, watch } from "vue";
import type { FutureBook } from "@/types";
import { useUserStore } from "@/stores/user";
import { useBooks } from "@/composables/useBooks";
import { useUIStore } from "@/stores/ui";
import { useLog } from "@/composables/useLog";
import { QUICK_ERROR, futureBookVotedSuccessAlert } from "@/constants";
import VoteCount from "./VoteCount.vue";
import VoteActions from "./VoteActions.vue";
import EditActions from "./EditActions.vue";
import FutureBookItemInfo from "./FutureBookItemInfo.vue";
import { useBooksStore } from "@/stores/books";

const props = defineProps<{
    book: FutureBook;
}>();

const { userIsFutureBookSelector, loggedInUser } = useUserStore();
const { showAlert, setIsAppLoading } = useUIStore();
const { setFutureBookModal } = useBooksStore();

const handleEdit = () =>
    setFutureBookModal({
        show: true,
        futureBook: props.book,
    });
const handleDelete = () => console.log("delete");

const userHasVoted = ref(props.book.votes.includes(loggedInUser.id));

const handleVote = async () => {
    try {
        setIsAppLoading(true);
        await useBooks().voteForFutureBook(props.book.id, loggedInUser.id);
    } catch (error) {
        await useLog().error(`Error voting for future book: ${error}`);
        showAlert(QUICK_ERROR(["voter fraud!", error as string]));
    } finally {
        useUIStore().setIsAppLoading(false);
        showAlert(futureBookVotedSuccessAlert(userHasVoted.value));
    }
};

watch(props.book.votes, (newVotes) => {
    console.log("\n KERTWANGING newVotes", newVotes, "\n\n");
    userHasVoted.value = newVotes.includes(loggedInUser.id);
});
</script>

<style scoped>
.future-book-item {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 100%;
    gap: 1rem;
}

.footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

@media (max-width: 768px) {
    .future-book-item {
        gap: 0.5rem;
    }
}
</style>
